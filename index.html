<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MONTROSE HUB - BUFFERED EDITION</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --cta-blue: #0056b3;
      --cta-red: #c60c30;
      --cta-brown: #62361b;
    }

    body {
      background-color: #0000AA; 
      color: #FFFFFF;
      font-family: 'Press Start 2P', cursive;
      margin: 0; padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      text-transform: uppercase;
      cursor: none;
    }

    /* CRT Overlay */
    body::after {
      content: " ";
      position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04));
      z-index: 100;
      background-size: 100% 4px, 4px 100%;
      pointer-events: none;
    }

    /* --- SPRITES --- */
    .sprite-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    .bus-sprite {
      position: absolute; bottom: 120px; width: 80px; height: 32px; background: #eee;
      border: 4px solid #000; box-shadow: inset 0 8px 0 #333, 0 4px 0 var(--cta-blue), 0 8px 0 var(--cta-red);
      animation: drive-bus 18s linear infinite;
    }
    .train-sprite {
      position: absolute; top: 150px; width: 120px; height: 28px; background: #bbb;
      border: 4px solid #000; box-shadow: inset 20px 0 0 #555, inset 60px 0 0 #555, inset 100px 0 0 #555, 0 -4px 0 var(--cta-brown);
      animation: drive-train 14s linear infinite;
    }
    @keyframes drive-bus { from { left: -100px; } to { left: 110vw; } }
    @keyframes drive-train { from { right: -150px; } to { right: 110vw; } }

    /* --- UI --- */
    .top-bar {
      display: flex; justify-content: space-between; padding: 20px 40px; 
      background-color: #000; color: #FFFF00; font-size: 14px; border-bottom: 4px solid #FFF; z-index: 10;
    }
    .container { padding: 30px 50px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-around; z-index: 5; }
    .section-box { background-color: rgba(0, 0, 0, 0.85); border: 4px solid #FFF; padding: 20px; box-shadow: 10px 10px 0px #000; }
    .label { font-size: 14px; margin-bottom: 15px; display: inline-block; padding: 5px; border: 2px solid; }
    .bus-color { color: #00FFFF; border-color: #00FFFF; }
    .train-color { color: #FFA500; border-color: #FFA500; }
    .arrival-row { font-size: 34px; margin: 10px 0; display: flex; align-items: center; }
    .live-icon { color: #00FF00; font-size: 12px; margin-left: 20px; }
    .sch-icon { color: #666; font-size: 10px; margin-left: 20px; }
    .due { color: #00FF00; }
    .blink { animation: step-blink 1s step-end infinite; }
    @keyframes step-blink { 50% { visibility: hidden; } }

    .ticker-wrap { background-color: #FF0000; color: #FFF; padding: 15px 0; font-size: 16px; border-top: 4px solid #FFF; z-index: 50; }
    .ticker { display: inline-block; white-space: nowrap; animation: marquee 25s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }
  </style>
</head>
<body>

  <div class="sprite-layer">
    <div class="train-sprite"></div>
    <div class="bus-sprite" style="animation-delay: 7s;"></div>
  </div>

  <div class="top-bar">
    <div id="clock">00:00:00</div>
    <div>CH. 78 TRANSIT-TV</div>
  </div>

  <div class="container">
    <div class="section-box">
      <div class="label bus-color">BUS 78 MONTROSE (WB)</div>
      <div id="bus-list"><div class="arrival-row">TUNING...</div></div>
    </div>

    <div class="section-box">
      <div class="label train-color">L BROWN LINE (LOOP)</div>
      <div id="train-list"><div class="arrival-row">TUNING...</div></div>
    </div>
  </div>

  <div class="ticker-wrap">
    <div class="ticker">
      MONTROSE HUB: 2-MINUTE DEPARTURE BUFFER ENABLED ... CHECKING LIVE TRANSIT FEEDS ... STAND CLEAR OF DOORS ... WEATHER: 28Â°F - CHICAGO WINTER ...
    </div>
  </div>

  <script>
    const BUS_KEY = "G2u3hCqi5yzbQppaPGcqAaVat";
    const TRAIN_KEY = "0fe79802b0f54862852c4d48ea6e51f1";
    
    const PROXIES = [
      "https://corsproxy.io/?",
      "https://api.allorigins.win/raw?url="
    ];
    let proxyIndex = 0;

    function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
    setInterval(updateClock, 1000);

    async function fetchCTA(targetUrl) {
      const cacheBuster = `&t=${Date.now()}`;
      const finalUrl = PROXIES[proxyIndex] + encodeURIComponent(targetUrl + cacheBuster);
      try {
        const r = await fetch(finalUrl);
        if (!r.ok) throw new Error();
        return await r.json();
      } catch (e) {
        proxyIndex = (proxyIndex + 1) % PROXIES.length;
        return null;
      }
    }

    async function getBusData() {
      const url = `https://www.ctabustracker.com/bustime/api/v2/getpredictions?key=${BUS_KEY}&rt=78&stpid=14828&format=json`;
      const data = await fetchCTA(url);
      if (!data) return;
      const prd = data["bustime-response"].prd;
      let html = "";
      if (prd) {
        prd.slice(0, 2).forEach(b => {
          const isDue = b.prdctdn === "DUE";
          html += `<div class="arrival-row ${isDue ? 'due blink' : ''}">${isDue ? 'DUE' : b.prdctdn + ' MIN'} <span class="live-icon">((( )))</span></div>`;
        });
      } else { html = '<div class="arrival-row" style="color:#666">NO BUSES</div>'; }
      document.getElementById('bus-list').innerHTML = html;
    }

    async function getTrainData() {
      const url = `https://lapi.transitchicago.com/api/1.0/ttarrivals.aspx?key=${TRAIN_KEY}&mapid=41500&rt=BRN&outputType=JSON`;
      const data = await fetchCTA(url);
      if (!data || !data.ctatt) return;
      
      const eta = data.ctatt.eta;
      let html = "";
      
      const loopTrains = eta ? eta.filter(t => t.trDr === "1") : [];

      if (loopTrains.length > 0) {
        loopTrains.slice(0, 2).forEach(t => {
          const rawDiff = Math.round((new Date(t.arrT) - new Date(t.prdt)) / 60000);
          
          // --- THE BUFFER ADJUSTMENT ---
          // Subtract 2 minutes, but don't let it go below 0.
          const bufferedDiff = Math.max(0, rawDiff - 2);
          
          const isLive = t.isApp === "1" || t.isSch === "0";
          const icon = isLive ? `<span class="live-icon ${bufferedDiff <= 1 ? 'blink' : ''}">((( )))</span>` : `<span class="sch-icon">[SCH]</span>`;
          
          // If buffered time is 1 min or 0 min, show "DUE"
          const timeStr = bufferedDiff <= 1 ? 'DUE' : bufferedDiff + ' MIN';
          
          html += `<div class="arrival-row ${bufferedDiff <= 1 ? 'due blink' : ''}">${timeStr} ${icon}</div>`;
        });
      } else { 
        html = '<div class="arrival-row" style="color:#666; font-size:12px;">NO LOOP TRAINS</div>'; 
      }
      document.getElementById('train-list').innerHTML = html;
    }

    function updateAll() { getBusData(); getTrainData(); }
    updateAll();
    setInterval(updateAll, 30000);
  </script>
</body>
</html>