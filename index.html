<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MONTROSE HUB - AUDIO EDITION</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --cta-blue: #0056b3;
      --cta-red: #c60c30;
      --cta-brown: #62361b;
    }

    body {
      background-color: #0000AA; 
      color: #FFFFFF;
      font-family: 'Press Start 2P', cursive;
      margin: 0; padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      text-transform: uppercase;
      cursor: auto; /* Changed to auto so you can see cursor to click sound button */
    }

    /* CRT Scanline Overlay */
    body::after {
      content: " ";
      position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04));
      z-index: 100;
      background-size: 100% 4px, 4px 100%;
      pointer-events: none;
    }

    /* --- SPRITES --- */
    .sprite-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    .bus-sprite {
      position: absolute; bottom: 120px; width: 80px; height: 32px; background: #eee;
      border: 4px solid #000; box-shadow: inset 0 8px 0 #333, 0 4px 0 var(--cta-blue), 0 8px 0 var(--cta-red);
      animation: drive-bus 18s linear infinite;
    }
    .train-sprite {
      position: absolute; top: 150px; width: 120px; height: 28px; background: #bbb;
      border: 4px solid #000; box-shadow: inset 20px 0 0 #555, inset 60px 0 0 #555, inset 100px 0 0 #555, 0 -4px 0 var(--cta-brown);
      animation: drive-train 14s linear infinite;
    }
    @keyframes drive-bus { from { left: -100px; } to { left: 110vw; } }
    @keyframes drive-train { from { right: -150px; } to { right: 110vw; } }

    /* --- UI --- */
    .top-bar {
      display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; 
      background-color: #000; color: #FFFF00; font-size: 14px; border-bottom: 4px solid #FFF; z-index: 10;
    }
    
    /* AUDIO BUTTON STYLE */
    .sound-btn {
      background: #000; color: #c60c30; border: 2px solid #c60c30;
      font-family: 'Press Start 2P', cursive; font-size: 12px;
      padding: 10px; cursor: pointer; text-transform: uppercase;
    }
    .sound-btn:hover { background: #222; }
    .sound-on { color: #00FF00; border-color: #00FF00; }

    .container { padding: 30px 50px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-around; z-index: 5; }
    .section-box { background-color: rgba(0, 0, 0, 0.85); border: 4px solid #FFF; padding: 20px; box-shadow: 10px 10px 0px #000; }
    .label { font-size: 14px; margin-bottom: 15px; display: inline-block; padding: 5px; border: 2px solid; }
    .bus-color { color: #00FFFF; border-color: #00FFFF; }
    .train-color { color: #FFA500; border-color: #FFA500; }
    .arrival-row { font-size: 34px; margin: 10px 0; display: flex; align-items: center; }
    .live-icon { color: #00FF00; font-size: 12px; margin-left: 20px; }
    .sch-icon { color: #666; font-size: 10px; margin-left: 20px; }
    .due { color: #00FF00; }
    .blink { animation: step-blink 1s step-end infinite; }
    @keyframes step-blink { 50% { visibility: hidden; } }

    .ticker-wrap { background-color: #FF0000; color: #FFF; padding: 15px 0; font-size: 16px; border-top: 4px solid #FFF; z-index: 50; }
    .ticker { display: inline-block; white-space: nowrap; animation: marquee 25s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }
  </style>
</head>
<body>

  <audio id="bg-music" loop>
    <source src="transit.mp3" type="audio/mpeg">
  </audio>

  <div class="sprite-layer">
    <div class="train-sprite"></div>
    <div class="bus-sprite" style="animation-delay: 7s;"></div>
  </div>

  <div class="top-bar">
    <div id="clock">00:00:00</div>
    <div>CH. 78 TRANSIT-TV</div>
    <button id="audio-toggle" class="sound-btn">SOUND: OFF</button>
  </div>

  <div class="container">
    <div class="section-box">
      <div class="label bus-color">BUS 78 MONTROSE (WB)</div>
      <div id="bus-list"><div class="arrival-row">LOADING...</div></div>
    </div>

    <div class="section-box">
      <div class="label train-color">L BROWN LINE (LOOP)</div>
      <div id="train-list"><div class="arrival-row">LOADING...</div></div>
    </div>
  </div>

  <div class="ticker-wrap">
    <div class="ticker" id="marquee-text">
      MONTROSE HUB INITIALIZED ... CHECKING FEEDS ...
    </div>
  </div>

  <script>
    // --- KEYS & CONFIG ---
    const BUS_KEY = "G2u3hCqi5yzbQppaPGcqAaVat";
    const TRAIN_KEY = "0fe79802b0f54862852c4d48ea6e51f1";

    let lastBusHtml = '<div class="arrival-row">LOADING...</div>';
    let lastTrainHtml = '<div class="arrival-row">LOADING...</div>';

    // --- AUDIO HANDLER ---
    const audioBtn = document.getElementById('audio-toggle');
    const player = document.getElementById('bg-music');
    
    audioBtn.addEventListener('click', () => {
      if (player.paused) {
        player.play().then(() => {
          audioBtn.textContent = "SOUND: ON";
          audioBtn.classList.add('sound-on');
        }).catch(e => {
          alert("File 'transit.mp3' not found in folder!");
        });
      } else {
        player.pause();
        audioBtn.textContent = "SOUND: OFF";
        audioBtn.classList.remove('sound-on');
      }
    });

    // --- CLOCK ---
    function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
    setInterval(updateClock, 1000);

    // --- BUS FETCH (Simple & Fast) ---
    async function getBusData() {
      const url = `https://www.ctabustracker.com/bustime/api/v2/getpredictions?key=${BUS_KEY}&rt=78&stpid=14828&format=json&random=${Date.now()}`;
      const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(url);
      
      try {
        const r = await fetch(proxyUrl, {cache: "no-store"});
        const data = await r.json();
        
        if (!data || !data["bustime-response"]) return;
        const prd = data["bustime-response"].prd;
        
        let html = "";
        if (prd) {
          prd.slice(0, 2).forEach(b => {
            const isDue = b.prdctdn === "DUE";
            html += `<div class="arrival-row ${isDue ? 'due blink' : ''}">${isDue ? 'DUE' : b.prdctdn + ' MIN'} <span class="live-icon">((( )))</span></div>`;
          });
        } else { html = '<div class="arrival-row" style="color:#666">NO BUSES</div>'; }
        
        lastBusHtml = html;
        document.getElementById('bus-list').innerHTML = html;
        
      } catch(e) { console.warn("Bus fetch hiccup"); }
    }

    // --- TRAIN FETCH (Hybrid Strategy) ---
    async function getTrainData() {
      const cleanUrl = `https://lapi.transitchicago.com/api/1.0/ttarrivals.aspx?key=${TRAIN_KEY}&mapid=41500&rt=BRN&outputType=JSON`;
      
      try {
        // Fast Proxy
        const hashUrl = cleanUrl + `#${Date.now()}`; 
        const fastProxy = "https://corsproxy.io/?" + encodeURIComponent(hashUrl);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const r = await fetch(fastProxy, { signal: controller.signal, cache: "no-store" });
        clearTimeout(timeoutId);
        
        const data = await r.json();
        processTrainData(data); 

      } catch (e) {
        console.warn("Switching to backup proxy...");
        // Slow/Reliable Proxy
        try {
          const wrapperUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(cleanUrl)}&rand=${Date.now()}`;
          const r2 = await fetch(wrapperUrl);
          const wrapperData = await r2.json();
          const realData = JSON.parse(wrapperData.contents);
          processTrainData(realData);
        } catch (e2) {
          if (lastTrainHtml.includes("LOADING")) {
            document.getElementById('train-list').innerHTML = '<div class="arrival-row" style="color:red; font-size:12px;">SIGNAL WEAK...</div>';
          }
        }
      }
    }

    function processTrainData(data) {
      if (!data || !data.ctatt) return;
      const eta = data.ctatt.eta;
      let html = "";
      const loopTrains = eta ? eta.filter(t => t.trDr === "5") : [];

      if (loopTrains.length > 0) {
        loopTrains.slice(0, 2).forEach(t => {
          const rawDiff = Math.round((new Date(t.arrT) - new Date(t.prdt)) / 60000);
          const bufferedDiff = Math.max(0, rawDiff - 2);
          const isLive = t.isApp === "1" || t.isSch === "0";
          const icon = isLive ? `<span class="live-icon ${bufferedDiff <= 1 ? 'blink' : ''}">((( )))</span>` : `<span class="sch-icon">[SCH]</span>`;
          const timeStr = bufferedDiff <= 1 ? 'DUE' : bufferedDiff + ' MIN';
          html += `<div class="arrival-row ${bufferedDiff <= 1 ? 'due blink' : ''}">${timeStr} ${icon}</div>`;
        });
      } else { 
        html = '<div class="arrival-row" style="color:#666; font-size:12px;">NO LOOP TRAINS</div>'; 
      }
      lastTrainHtml = html;
      document.getElementById('train-list').innerHTML = html;
    }

    // --- WEATHER ---
    async function updateTicker() {
      let weatherMsg = "";
      try {
        const wRes = await fetch("https://api.open-meteo.com/v1/forecast?latitude=41.96&longitude=-87.67&current=temperature_2m&temperature_unit=fahrenheit");
        const wData = await wRes.json();
        const temp = Math.round(wData.current.temperature_2m);
        weatherMsg = `WEATHER: ${temp}Â°F ... `;
      } catch (e) {}

      const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const msg = `MONTROSE HUB: LIVE UPDATES [${now}] ... 2-MINUTE BUFFER ACTIVE ... ${weatherMsg}HAVE A SAFE COMMUTE ...`;
      document.getElementById('marquee-text').textContent = msg;
    }

    function updateAll() { getBusData(); getTrainData(); }
    updateAll();
    updateTicker();
    setInterval(updateAll, 30000);
    setInterval(updateTicker, 600000); 
  </script>
</body>
</html>