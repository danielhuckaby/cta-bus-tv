<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CTA CRT BROADCAST</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #0000AA; 
      color: #FFFFFF;
      font-family: 'Press Start 2P', cursive;
      margin: 0; padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      text-transform: uppercase;
      cursor: none;
    }

    /* CRT Overlay */
    body::after {
      content: " ";
      position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04));
      z-index: 100;
      background-size: 100% 3px, 3px 100%;
      pointer-events: none;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      padding: 20px 40px;
      background-color: #000;
      color: #FFFF00;
      font-size: 14px;
      border-bottom: 4px solid #FFF;
    }

    .container {
      padding: 40px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .header-box {
      background-color: #000;
      border: 4px solid #FFFF00;
      padding: 20px;
      box-shadow: 12px 12px 0px #FF00FF;
      margin-bottom: 20px;
    }

    .route-name { color: #00FFFF; font-size: 22px; margin-bottom: 10px; }
    .arrival-main { font-size: 48px; color: #00FF00; margin: 30px 0; }
    
    /* Service Alert Popup */
    #alert-box {
      display: none; /* Hidden by default */
      background-color: #FF0000;
      border: 8px double #FFF;
      padding: 20px;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      text-align: center;
      box-shadow: 20px 20px 0px #000;
    }

    .ticker-wrap {
      width: 100%;
      background-color: #FF0000;
      color: #FFF;
      padding: 15px 0;
      font-size: 16px;
      border-top: 4px solid #FFF;
    }

    .ticker {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 20s linear infinite;
    }

    @keyframes marquee {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100%); }
    }

    .blink { animation: step-blink 1s step-end infinite; }
    @keyframes step-blink { 50% { visibility: hidden; } }
  </style>
</head>
<body>

  <div id="alert-box">
    <div class="blink" style="font-size: 24px; margin-bottom: 10px;">! SERVICE ALERT !</div>
    <div style="font-size: 12px;">DELAYS REPORTED ON ROUTE 78</div>
  </div>

  <div class="top-bar">
    <div id="clock">00:00:00</div>
    <div>CH. 78 BUS-TV</div>
  </div>

  <div class="container">
    <div class="header-box">
      <div class="route-name">RT 78 MONTROSE</div>
      <div style="font-size: 12px;">WESTBOUND / ASHLAND</div>
    </div>
    <div id="schedule">
      <div class="arrival-main">TUNING...</div>
    </div>
  </div>

  <div class="ticker-wrap">
    <div class="ticker">
      WEATHER: 28Â°F - CHANCE OF FLURRIES ... CTA SYSTEM STATUS: OPERATIONAL ... STAND CLEAR OF DOORS ... THANK YOU FOR RIDING CTA ...
    </div>
  </div>

  <script>
    const API_KEY = "G2u3hCqi5yzbQppaPGcqAaVat";
    const ROUTE = "78";
    const STOP_ID = "14828";
    const PROXY_URL = "https://corsproxy.io/?";
    const CTA_URL = `https://www.ctabustracker.com/bustime/api/v2/getpredictions?key=${API_KEY}&rt=${ROUTE}&stpid=${STOP_ID}&format=json`;

    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);

    async function fetchBusTime() {
      try {
        const response = await fetch(PROXY_URL + encodeURIComponent(CTA_URL));
        const data = await response.json();
        const prd = data["bustime-response"].prd;
        const scheduleEl = document.getElementById("schedule");
        const alertBox = document.getElementById("alert-box");

        if (!prd || prd.length === 0) {
          scheduleEl.innerHTML = `<div class="arrival-main" style="color:#FF0000">NO SERVICE</div>`;
          return;
        }

        // Check for delays
        const isDelayed = prd.some(bus => bus.dly === "1");
        alertBox.style.display = isDelayed ? "block" : "none";

        let html = "";
        prd.slice(0, 2).forEach((bus, i) => {
          const isDue = bus.prdctdn === "DUE";
          const time = isDue ? "DUE" : bus.prdctdn + " MIN";
          if(i === 0) {
            html += `<div class="arrival-main ${isDue ? 'blink' : ''}">NEXT: ${time}</div>`;
          } else {
            html += `<div style="color:#FFA500; font-size:18px;">FOLLOWING: ${time}</div>`;
          }
        });
        scheduleEl.innerHTML = html;
      } catch (e) { console.error(e); }
    }

    fetchBusTime();
    setInterval(fetchBusTime, 30000);
  </script>
</body>
</html>